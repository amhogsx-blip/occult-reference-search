<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Occult Reference Net</title>

<!-- Favicon (prevents /favicon.ico 404) -->
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='100%25' height='100%25' fill='black'/%3E%3Ccircle cx='32' cy='36' r='16' fill='%23ff69b4'/%3E%3C/svg%3E">

<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
<!-- FlexSearch (global `FlexSearch`) -->
<script src="https://cdn.jsdelivr.net/npm/flexsearch@0.7.31/dist/flexsearch.bundle.js"></script>

<style>
  :root{ --bg:#000; --fg:#fff; --accent:#00ff99; --muted:#bdbdbd; --border:#333; --panel:#0b0b0b; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--fg);
    font-family:"Press Start 2P",monospace;font-size:12px;line-height:1.45;
    display:flex;flex-direction:column;overflow-x:hidden;position:relative;
    cursor:none;
  }
  /* CRT */
  body::before{
    content:"";position:fixed;inset:0;z-index:1;pointer-events:none;
    background:
      radial-gradient(1200px 600px at 50% -10%, rgba(0,255,153,.20), rgba(0,0,0,0) 60%),
      repeating-linear-gradient(0deg, rgba(0,255,153,.09) 0px, rgba(0,255,153,.09) 1px, rgba(0,0,0,0) 2px, rgba(0,0,0,0) 4px);
    mix-blend-mode:screen;animation:scanFlicker 6s linear infinite;
  }
  body::after{
    content:"";position:fixed;inset:0;z-index:1;pointer-events:none;
    box-shadow:inset 0 0 140px rgba(0,255,153,.22), inset 0 0 340px rgba(0,255,153,.15);
  }
  @keyframes scanFlicker{0%{opacity:.25}45%{opacity:.32}50%{opacity:.22}55%{opacity:.32}100%{opacity:.25}}

  /* Header */
  .wrap{position:relative;z-index:2;display:flex;flex-direction:column;align-items:center}
  .title{margin:28px 12px 10px;text-align:center;font-size:clamp(22px,5vw,46px);letter-spacing:2px;text-shadow:0 0 10px rgba(0,255,153,.22)}
  .logo-wrap{display:flex;justify-content:center;margin:10px 0 18px}
  .logo{width:min(520px,70vw);height:auto;image-rendering:pixelated;image-rendering:crisp-edges;filter:drop-shadow(0 0 16px rgba(0,0,0,.65))}
  .search-row{display:flex;align-items:center;gap:12px;margin:12px auto 10px;padding:0 16px}
  .label{font-size:14px}
  .field{display:flex;align-items:stretch;border:2px solid var(--fg);background:#000}
  input[type="search"]{width:min(640px,70vw);padding:12px 14px;border:0;outline:none;background:#000;color:#fff;font:inherit}
  button{min-width:44px;border:0;background:#000;color:#fff;cursor:pointer;border-left:2px solid var(--fg);padding:0 10px}
  .mag::before{content:"\1F50D";display:block;line-height:42px;text-align:center}
  .menu{display:flex;gap:min(9vw,88px);flex-wrap:wrap;justify-content:center;margin:8px 0 16px;padding:0 16px}
  .menu a{color:#fff;text-decoration:underline;text-decoration-thickness:3px;text-underline-offset:8px;letter-spacing:1px;font-size:16px}
  .menu a:hover{text-decoration-color:var(--accent);text-shadow:0 0 8px rgba(255,255,255,.35)}

  /* Filters */
  .filters{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:4px 0 12px}
  .chip{
    border:1px solid #2a5; color:#9effd2; background:#000; cursor:pointer;
    padding:6px 10px; font-size:10px; border-radius:999px; user-select:none;
  }
  .chip.active{ border-color: var(--accent); color:#fff; box-shadow: 0 0 8px rgba(0,255,153,.35) inset; }

  /* Two-column layout */
  .content{display:grid;grid-template-columns:minmax(0,1fr) 320px;gap:18px;align-items:start;width:92vw;max-width:1200px;margin:0 auto 28px;z-index:2}
  @media (max-width:980px){ .content{grid-template-columns:1fr} }

  /* Results */
  .results{ display:grid; gap:12px }
  .section-title{ color:#8ac6ad; font-size:11px; margin:14px 0 4px; letter-spacing:1px }
  .result{
    border:1px solid var(--border); background:#000; padding:14px; display:grid; grid-template-columns:auto 1fr; gap:10px;
  }
  .favicon{ width:16px; height:16px; margin-top:3px; filter: drop-shadow(0 0 4px rgba(255,255,255,.15)); }
  .meta-row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; color:#8ac6ad; font-size:10px }
  .urlcrumb{ color:#8ac6ad; opacity:.9; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:100% }
  .badge{ border:1px solid #2a5; color:#9effd2; font-size:10px; padding:1px 6px; border-radius:4px }
  .badge.pdf{ border-color:#a25; color:#ffb6c6 }
  .titleline{ margin-top:2px }
  .result-title{ color:var(--accent); text-decoration:underline; font-size:14px }
  .snippet{ color:#cfe; margin-top:6px; font-size:11px }
  .actions{ display:flex; gap:10px; margin-top:8px; flex-wrap:wrap }
  .action-btn{
    background:#000; color:#fff; border:1px solid #3a3a3a; padding:6px 10px; font-size:10px; cursor:pointer;
  }
  .action-btn:hover{ border-color: var(--accent); text-shadow:0 0 6px rgba(255,255,255,.3) }
  mark{ background:transparent; color:var(--accent); text-decoration:underline; text-underline-offset:2px; text-decoration-thickness:2px }

  /* More results */
  .more-wrap{ display:flex; justify-content:center; margin:12px 0 0 }
  .more-btn{ background:#000; color:#fff; border:1px solid #3a3a3a; padding:8px 14px; font-size:11px; cursor:pointer; }
  .more-btn:hover{ border-color: var(--accent); }

  /* Wiki panel (hidden by default; shown after search) */
  .panel{ border:1px solid var(--border); background:var(--panel); padding:12px; position:sticky; top:14px; }
  .panel h3{ margin:4px 0 8px; font-size:14px }
  .panel small{ color:var(--muted) }
  .wthumb{ width:100%; height:auto; border:1px solid #1f1f1f; background:#000; display:block; margin:8px 0 }
  .wdesc{ color:#dfe; font-size:11px; margin-top:6px }
  .wlinks{ display:flex; gap:8px; margin-top:8px; flex-wrap:wrap }
  .wbtn{ background:#000; color:#fff; border:1px solid #3a3a3a; padding:6px 10px; font-size:10px; cursor:pointer; text-decoration:none; }
  .wbtn:hover{ border-color: var(--accent); text-shadow:0 0 6px rgba(255,255,255,.3) }
  .wmuted{ color:#8ac6ad; font-size:10px; margin-top:4px }

  /* PDF modal */
  #pdfModal{ position:fixed; inset:0; background:rgba(0,0,0,.8); display:none; z-index:10050; }
  #pdfInner{ position:absolute; inset:5% 5%; background:#000; border:1px solid #333; display:flex; flex-direction:column; }
  #pdfBar{ padding:6px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center; }
  #pdfFrame{ flex:1; width:100%; border:0; background:#111 }
  .closeX{ background:#000; color:#fff; border:1px solid #444; padding:4px 10px; cursor:pointer; }
  .closeX:hover{ border-color: var(--accent); }

  footer{margin-top:auto;padding:16px 10px;text-align:center;color:var(--muted);border-top:1px solid #233;z-index:2;font-size:10px}

  /* Retro pixel-arrow cursor with glow */
  .crt-cursor{
    position:fixed;left:0;top:0;width:26px;height:36px;pointer-events:none;z-index:10002;
    background:#fff;
    clip-path:polygon(0% 0%,0% 100%,30% 70%,40% 80%,40% 100%,55% 100%,55% 82%,70% 82%,70% 64%,55% 64%,55% 40%,80% 40%,80% 22%,55% 22%,55% 0%);
    image-rendering:pixelated;
    filter:
      drop-shadow(1px 0 0 #000) drop-shadow(-1px 0 0 #000)
      drop-shadow(0 1px 0 #000) drop-shadow(0 -1px 0 #000)
      drop-shadow(0 0 7px rgba(255,255,255,.85))
      drop-shadow(0 0 22px rgba(255,255,255,.55))
      drop-shadow(0 0 60px rgba(255,255,255,.35));
    transform:translate(-2px,-2px);transition:transform .08s ease-out;
  }
  .crt-cursor.click{transform:translate(-2px,-2px) scale(.92)}
  @media (max-width:560px){.label{display:none}.menu{gap:28px}.menu a{font-size:14px;text-underline-offset:6px}}
</style>
</head>
<body>
  <div class="wrap">
    <div class="title">The Occult Reference Net</div>
    <div class="logo-wrap"><img src="GB-Logo_TORN.png" alt="Ghostbusters pixel logo" class="logo"></div>

    <div class="search-row">
      <div class="label">Search:</div>
      <div class="field">
        <input id="q" type="search" placeholder="Are you the Keymaster?">
        <button id="go" aria-label="Search"><span class="mag" aria-hidden="true"></span></button>
      </div>
    </div>

    <nav class="menu" aria-label="Main menu">
      <a href="index.html">Home</a>
      <a href="about.html">About</a>
      <a href="contact.html">Contact</a>
      <a href="sponsors.html">Sponsors</a>
      <a href="forum.html">Forum</a>
    </nav>

    <!-- Dynamic filter chips -->
    <div id="filters" class="filters"></div>
  </div>

  <!-- Two-column results + wiki panel -->
  <main class="content">
    <section id="results" class="results" aria-live="polite"></section>
    <!-- HIDDEN BY DEFAULT -->
    <aside id="wiki" class="panel" aria-live="polite" style="display:none;">
      <h3>Quick Summary</h3>
      <small>Powered by Wikipedia</small>
      <div id="wContent" class="wdesc">Type a query to see an overview here.</div>
    </aside>
  </main>

  <footer>Helping paranormal investigators everywhere find the things that go bump in the night since Â© 1989.</footer>

  <!-- PDF modal -->
  <div id="pdfModal" aria-hidden="true">
    <div id="pdfInner">
      <div id="pdfBar">
        <div id="pdfTitle">PDF Preview</div>
        <button class="closeX" id="pdfClose">Close</button>
      </div>
      <iframe id="pdfFrame" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
    </div>
  </div>

  <!-- Retro pixel-arrow cursor -->
  <script>
    (function(){
      const cursor=document.createElement('div');
      cursor.className='crt-cursor';
      document.body.appendChild(cursor);
      const hotspotX=2, hotspotY=2;
      let x=innerWidth/2,y=innerHeight/2,tx=x,ty=y; const speed=.35;
      function move(e){tx=e.clientX-hotspotX;ty=e.clientY-hotspotY;}
      function loop(){x+=(tx-x)*speed;y+=(ty-y)*speed;cursor.style.left=x+'px';cursor.style.top=y+'px';requestAnimationFrame(loop);}
      addEventListener('mousemove',move,{passive:true});
      addEventListener('mousedown',()=>cursor.classList.add('click'));
      addEventListener('mouseup',()=>cursor.classList.remove('click'));
      loop();
      document.querySelectorAll('input,textarea').forEach(el=>{
        el.addEventListener('mouseenter',()=>{document.body.style.cursor='text';});
        el.addEventListener('mouseleave',()=>{document.body.style.cursor='none';});
      });
    })();
  </script>

  <!-- Search + Filters + Wiki + Pagination -->
  <script>
    // ---------- Utils ----------
    function fmtBytes(b){ if(!b||isNaN(b)) return ""; const u=["B","KB","MB","GB"]; let i=0,n=b; while(n>=1024&&i<u.length-1){n/=1024;i++;} return n.toFixed(n<10&&i>0?1:0)+" "+u[i]; }
    function escapeRegExp(s){return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');}
    function highlight(t,q){ if(!t||!q) return t||""; const terms=[...new Set(q.trim().split(/\s+/).filter(Boolean))]; if(!terms.length) return t; const re=new RegExp("(" + terms.map(escapeRegExp).join("|") + ")", "ig"); return t.replace(re,"<mark>$1</mark>");}
    function faviconURL(domain){ return "https://www.google.com/s2/favicons?domain=" + encodeURIComponent(domain) + "&sz=16"; }
    function getParam(name){ const url=new URL(location.href); return url.searchParams.get(name); }
    function setParam(name, value){ const url=new URL(location.href); if(value){url.searchParams.set(name,value)}else{url.searchParams.delete(name)} history.replaceState(null,"",url.toString()); }

    // ---------- Data ----------
    let data=[];       // raw records
    let fx=null;       // FlexSearch index
    let byId={};       // id -> record
    let activeFilter="all";
    const PAGE_SIZE=10;
    let lastQuery="", pageCursor=0, currentHits=[];

    async function loadIndex(){
      try{
        const r=await fetch("index.json",{cache:"no-store"});
        data=await r.json();
        data.forEach((d,i)=>{ d.id=i; d.domain=d.domain || new URL(d.url).hostname; byId[i]=d; });
        buildFilters();
        await buildFlexSearch();
        console.log("Search index loaded:", data.length, "records");
      }catch(e){
        console.warn("index.json missing or invalid; search will be empty.", e);
        data=[];
      }
    }

    async function buildFlexSearch(){
      try{
        if(!window.FlexSearch) throw new Error("FlexSearch not available");
        fx = new FlexSearch.Document({
          tokenize: "forward",
          cache: true,
          document: {
            id: "id",
            index: [
              { field: "title", tokenize:"forward", weight: 8 },
              { field: "snippet", tokenize:"forward", weight: 4 },
              { field: "collection", tokenize:"forward", weight: 3 },
              { field: "domain", tokenize:"forward", weight: 2 },
              { field: "tags", tokenize:"forward", weight: 2 }
            ],
            store: ["id"]
          }
        });
        for(const rec of data){ fx.add(rec); }
      }catch(e){
        fx = null; // fall back
      }
    }

    // ---------- Filters ----------
    function uniqueCollections(){
      const set = new Set();
      data.forEach(d=>{ if(d.collection) set.add(d.collection); });
      return Array.from(set).sort();
    }

    function buildFilters(){
      const cont = document.getElementById('filters');
      const colls = uniqueCollections();
      cont.innerHTML = "";
      const mk = (label,val)=> {
        const a=document.createElement('button'); a.className='chip'; a.textContent=label; a.dataset.value=val;
        if(val===activeFilter) a.classList.add('active');
        a.onclick=()=>{ activeFilter=val; document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); a.classList.add('active'); setParam('site', val==='all'?"":val); runSearch(); };
        cont.appendChild(a);
      };
      mk("All","all");
      colls.forEach(c=> mk(c, c));
      const siteParam = getParam('site');
      if(siteParam && (siteParam==="all" || colls.includes(siteParam))){
        activeFilter = siteParam;
        document.querySelectorAll('.chip').forEach(c=>{ if(c.dataset.value===activeFilter) c.classList.add('active'); });
      }
    }

    function applyFilter(list){
      if(activeFilter==="all") return list;
      return list.filter(r => (r.collection||"") === activeFilter);
    }

    // ---------- Search ----------
    function fallbackSearch(q){
      const ql=q.toLowerCase();
      return data.map(d=>{
        const title=(d.title||"").toLowerCase();
        const snip=(d.snippet||"").toLowerCase();
        const coll=(d.collection||"").toLowerCase();
        const dom =(d.domain||"").toLowerCase();
        let score=0;
        if(title.includes(ql)) score+=2.5;
        if(snip.includes(ql)) score+=1.2;
        if(coll.includes(ql)) score+=0.6;
        if(dom.includes(ql))  score+=0.3;
        if(d.is_pdf) score+=0.2;
        return {doc:d,score};
      }).filter(x=>x.score>0).sort((a,b)=>b.score-a.score).map(x=>x.doc);
    }

    async function search(q){
      if(!data.length) await loadIndex();
      let hits=[];
      if(fx){
        const res = await fx.search(q, { enrich:true, limit:200 });
        const ids = []; const seen = new Set();
        for(const group of res){
          for(const m of group.result){
            if(!seen.has(m.id)){ seen.add(m.id); ids.push(m.id); }
          }
        }
        hits = ids.map(id=>byId[id]);
      } else {
        hits = fallbackSearch(q);
      }
      hits = applyFilter(hits);
      return hits;
    }

    function renderSection(items, q){
      return items.map(h=>{
        const dom = h.domain || (new URL(h.url)).hostname;
        const size = h.filesize ? fmtBytes(h.filesize) : "";
        const when = h.lastmod || "";
        const badges = [];
        if(h.is_pdf) badges.push(`<span class="badge pdf">PDF</span>`);
        if(size)     badges.push(`<span class="badge">${size}</span>`);
        if(when)     badges.push(`<span class="badge">${when}</span>`);
        return `
          <div class="result">
            <img class="favicon" src="${faviconURL(dom)}" alt="">
            <div>
              <div class="meta-row">
                <span class="urlcrumb">${dom}${h.collection?` Â· ${h.collection}`:""}</span>
                ${badges.join(" ")}
              </div>
              <div class="titleline">
                <a class="result-title" href="${h.url}" target="_blank" rel="noopener">${highlight(h.title||h.url,q)}</a>
              </div>
              <div class="snippet">${highlight(h.snippet||"",q)}</div>
              <div class="actions">
                <a class="action-btn" href="${h.url}" target="_blank" rel="noopener">Open</a>
                ${h.is_pdf ? `<button class="action-btn preview-btn" data-url="${h.url}" data-title="${encodeURIComponent(h.title||'PDF')}">Preview</button>` : ``}
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    function renderResults(q, hits, append=false){
      const box=document.getElementById('results');
      if(!append){
        box.innerHTML = "";
        pageCursor = 0;
      }
      if(!hits.length){
        box.innerHTML = "<div class='result'><div></div><div>No results. Try broader terms.</div></div>";
        document.getElementById('moreWrap')?.remove();
        return;
      }

      const nextChunk = hits.slice(pageCursor, pageCursor + PAGE_SIZE);
      if(!append){
        const pdfs = hits.filter(h=>h.is_pdf);
        const nonpdf = hits.filter(h=>!h.is_pdf);
        const top = nonpdf.slice(0,6).concat(pdfs.slice(0,4));
        const restStart = new Set(top.map(t=>t.id));
        const rest = hits.filter(h=>!restStart.has(h.id));
        const firstBatch = (top.concat(rest)).slice(0, PAGE_SIZE);
        box.innerHTML = renderSection(firstBatch, q);
        pageCursor = firstBatch.length;
      } else {
        box.insertAdjacentHTML('beforeend', renderSection(nextChunk, q));
        pageCursor += nextChunk.length;
      }

      document.querySelectorAll('.preview-btn').forEach(btn=>{
        btn.onclick = ()=>{
          const url=btn.getAttribute('data-url');
          const t = decodeURIComponent(btn.getAttribute('data-title')||'PDF Preview');
          openPdfPreview(url, t);
        };
      });

      document.getElementById('moreWrap')?.remove();
      if(pageCursor < hits.length){
        const wrap = document.createElement('div');
        wrap.id = 'moreWrap';
        wrap.className = 'more-wrap';
        const btn = document.createElement('button');
        btn.className = 'more-btn';
        btn.textContent = 'More results';
        btn.onclick = ()=> renderResults(q, hits, true);
        wrap.appendChild(btn);
        box.parentElement.insertBefore(wrap, box.nextSibling);
      }
    }

    // ---------- PDF Modal ----------
    const modal = document.getElementById('pdfModal');
    const frame = document.getElementById('pdfFrame');
    const titleEl = document.getElementById('pdfTitle');
    const closeBtn = document.getElementById('pdfClose');
    function openPdfPreview(url, title){
      const viewer = "https://docs.google.com/gview?embedded=1&url=" + encodeURIComponent(url);
      frame.src = viewer;
      titleEl.textContent = title || "PDF Preview";
      modal.style.display = 'block';
      modal.setAttribute('aria-hidden','false');
    }
    function closePdf(){
      frame.src = "about:blank";
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
    }
    closeBtn.addEventListener('click', closePdf);
    modal.addEventListener('click', (e)=>{ if(e.target===modal) closePdf(); });
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closePdf(); });

    // ---------- Wikipedia panel ----------
    const wikiPanel = document.getElementById('wiki');
    const wBox = document.getElementById('wContent');
    async function fetchWikiSummary(q){
      if(!q) { wBox.textContent = "Type a query to see an overview here."; return; }
      try{
        const s = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(q)}`);
        if(s.ok){
          const j = await s.json();
          const thumb = j.thumbnail && j.thumbnail.source ? `<img class="wthumb" src="${j.thumbnail.source}" alt="">` : "";
          const desc = j.extract ? j.extract : "No summary available.";
          const link = j.content_urls && j.content_urls.desktop ? j.content_urls.desktop.page : `https://en.wikipedia.org/wiki/${encodeURIComponent(q)}`;
          wBox.innerHTML = `
            ${thumb}
            <div class="wdesc">${desc}</div>
            <div class="wlinks">
              <a class="wbtn" target="_blank" rel="noopener" href="${link}">Read on Wikipedia</a>
              <a class="wbtn" target="_blank" rel="noopener" href="https://en.wikipedia.org/w/index.php?search=${encodeURIComponent(q)}">Search Wikipedia</a>
            </div>
          `;
          return;
        }
        const sug = await fetch(`https://en.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(q)}&limit=1&namespace=0&format=json&origin=*`);
        const sj = await sug.json();
        const suggested = sj && sj[1] && sj[1][0];
        if(suggested){
          wBox.innerHTML = `
            <div class="wdesc">No exact article for <b>${q}</b>. Did you mean <b>${suggested}</b>?</div>
            <div class="wlinks">
              <a class="wbtn" target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/${encodeURIComponent(suggested)}">Open â${suggested}â</a>
              <a class="wbtn" target="_blank" rel="noopener" href="https://en.wikipedia.org/w/index.php?search=${encodeURIComponent(q)}">Search Wikipedia</a>
            </div>
            <div class="wmuted">Tip: try a singular noun (e.g., âdemonâ instead of âdemonsâ).</div>
          `;
        } else {
          wBox.innerHTML = `
            <div class="wdesc">No Wikipedia match for <b>${q}</b>.</div>
            <div class="wlinks">
              <a class="wbtn" target="_blank" rel="noopener" href="https://en.wikipedia.org/w/index.php?search=${encodeURIComponent(q)}">Search Wikipedia</a>
            </div>
          `;
        }
      }catch(e){
        wBox.innerHTML = `<div class="wdesc">Could not load Wikipedia right now.</div>`;
      }
    }

    // ---------- Wire search & params ----------
    const qEl=document.getElementById('q');
    const def="Are you the Keymaster?";
    qEl.value = getParam('q') || def;
    qEl.addEventListener('focus', ()=>{ if(qEl.value===def) qEl.value=""; });
    qEl.addEventListener('blur',  ()=>{ if(qEl.value.trim()==="") qEl.value=def; });

    async function runSearch(){
      const q=qEl.value.trim();
      setParam('q', q && q!==def ? q : "");
      if(!data.length) await loadIndex();
      document.getElementById('results').innerHTML = "";

      // Hide wiki panel until a *real* query is provided
      if(!q || q===def){
        wikiPanel.style.display = "none";
        document.getElementById('moreWrap')?.remove();
        return;
      }

      currentHits = await search(q);
      lastQuery = q;
      renderResults(q, currentHits, false);

      // Show wiki panel only after searching
      wikiPanel.style.display = "block";
      fetchWikiSummary(q);
    }

    document.getElementById('go').addEventListener('click', runSearch);
    qEl.addEventListener('keydown', e=>{ if(e.key==="Enter"){ e.preventDefault(); runSearch(); }});

    // Initialize (respect ?q= and ?site=)
    window.addEventListener('load', async ()=>{
      await loadIndex();
      const qStart = getParam('q');
      if(qStart){ qEl.value = qStart; }
      runSearch(); // will keep wiki hidden until query is real
    });
  </script>
</body>
</html>
