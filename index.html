<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>The Occult Reference Net</title>

<!-- Favicon to silence /favicon.ico 404 -->
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='100%25' height='100%25' fill='black'/%3E%3Ccircle cx='32' cy='36' r='16' fill='%23ff69b4'/%3E%3C/svg%3E">

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<!-- FlexSearch (must load before our search code) -->
<script src="https://cdn.jsdelivr.net/npm/flexsearch@0.7.31/dist/flexsearch.bundle.js"></script>

<style>
  :root{ --bg:#000; --fg:#fff; --muted:#bbb; --accent:#00ff99; --border:#333; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font-family:"Press Start 2P",monospace; font-size:12px; line-height:1.45;
    display:flex; flex-direction:column; overflow-x:hidden; position:relative;
    cursor:none; /* hide system cursor; we draw our own */
  }

  /* CRT vibe */
  body::before, body::after{content:"";position:fixed;inset:0;pointer-events:none;z-index:2}
  body::before{
    background:
      linear-gradient(rgba(0,255,153,.06), rgba(0,255,153,.06)) 0 0/100% 100%,
      repeating-linear-gradient(0deg, rgba(0,255,153,.08) 0, rgba(0,255,153,.08) 1px, transparent 2px, transparent 4px);
    mix-blend-mode:screen; animation:scan 6s infinite linear;
  }
  body::after{box-shadow:inset 0 0 120px rgba(0,255,153,.12), inset 0 0 280px rgba(0,255,153,.08)}
  @keyframes scan{0%{opacity:.22}45%{opacity:.28}50%{opacity:.20}55%{opacity:.28}100%{opacity:.22}}

  a{color:var(--accent); text-decoration:none}
  a:hover{text-decoration:underline}

  .title{margin:28px 12px 10px;text-align:center;font-size:clamp(22px,5vw,46px);letter-spacing:2px;text-shadow:0 0 8px rgba(0,255,153,.2)}
  .logo-wrap{display:flex;justify-content:center;margin:10px 0 18px}
  .logo{width:min(520px,80vw);height:auto;image-rendering:pixelated;image-rendering:crisp-edges;filter:drop-shadow(0 0 18px rgba(0,0,0,.6))}

  /* Search */
  .search-wrap{display:flex;justify-content:center;align-items:center;gap:12px;margin:6px auto 18px;padding:0 16px;width:100%}
  .label{font-size:14px}
  .field{display:flex;align-items:stretch;gap:0;border:2px solid var(--fg);background:#000}
  input[type="search"]{width:min(560px,70vw);padding:12px 14px;border:0;outline:none;background:#000;color:#fff;font:inherit}
  button{background:#000;color:#fff;border:0;width:42px;padding:0;cursor:pointer;border-left:2px solid var(--fg)}
  .mag::before{content:"\1F50D";display:block;line-height:42px;text-align:center}

  /* Buttons */
  .btnbar{display:flex;justify-content:center;gap:min(8vw,80px);margin:14px auto 20px;padding:0 16px;flex-wrap:wrap}
  .btn{color:#fff;text-decoration:underline;text-decoration-thickness:3px;text-underline-offset:8px;letter-spacing:1px;font-size:16px}
  .btn:hover{color:#fff;text-decoration-color:var(--accent);text-shadow:0 0 8px rgba(255,255,255,.35)}

  .results{max-width:960px;width:92vw;margin:0 auto 32px;display:grid;gap:12px;z-index:1}
  .card{border:1px solid var(--border);padding:14px;background:#000}
  .src{color:var(--accent);font-size:10px;margin-bottom:6px}
  .titlelink{color:var(--accent);text-decoration:underline}
  .snippet{color:var(--accent);margin-top:4px}

  footer{margin-top:auto;padding:18px 10px;text-align:center;color:var(--muted);border-top:1px solid var(--border);z-index:1}
  .small{font-size:10px}
  mark{background:transparent;color:var(--accent);padding:0;text-decoration:underline;text-underline-offset:2px;text-decoration-thickness:2px}

  /* Slime overlay */
  #gooWrap{position:fixed;inset:0;z-index:9999;display:none}
  #goo, #gooHud{position:absolute;inset:0;width:100%;height:100%;display:block}
  #gooHud{pointer-events:none}
  #gooClose{
    position:absolute; top:10px; right:12px; z-index:10000;
    width:28px; height:28px; line-height:24px; border-radius:50%;
    border:1px solid #333; background:rgba(0,0,0,.35); color:#fff; cursor:pointer; display:none;
  }

  /* Retro pixel-arrow cursor with CRT glow */
  .crt-cursor{
    position:fixed; left:0; top:0; width:22px; height:32px; pointer-events:none; z-index:10001;
    /* pixel arrow shape */
    clip-path: polygon(0 0, 0 100%, 40% 70%, 70% 100%, 70% 65%, 100% 65%, 100% 35%, 70% 35%, 70% 0);
    background:#fff;
    image-rendering: pixelated;
    filter:
      drop-shadow(0 0 2px rgba(255,255,255,0.95))
      drop-shadow(0 0 6px rgba(255,255,255,0.75))
      drop-shadow(0 0 14px rgba(255,255,255,0.45));
    transform: translate(-2px,-2px);
    transition: transform .08s ease-out;
  }
  .crt-cursor.click{ transform: translate(-2px,-2px) scale(0.9); }

  /* Let inputs show I-beam cursor as normal, while our custom arrow still follows */
  input, textarea { cursor:text; }
</style>
</head>
<body>

  <div class="title">The Occult Reference Net</div>
  <div class="logo-wrap"><img src="GB-Logo_TORN.png" alt="Ghostbusters pixel logo" class="logo"></div>

  <div class="search-wrap">
    <div class="label">Search:</div>
    <div class="field">
      <input id="q" type="search" placeholder="Are you the Keymaster?">
      <button id="go" aria-label="Search"><span class="mag" aria-hidden="true"></span></button>
    </div>
  </div>

  <nav class="btnbar" aria-label="Quick links">
    <a class="btn" href="index.html">Home</a>
    <a class="btn" href="about.html">About</a>
    <a class="btn" href="contact.html">Contact</a>
    <a class="btn" href="sponsors.html">Sponsors</a>
    <a class="btn" href="forum.html">Forum</a>
  </nav>

  <div id="results" class="results"></div>

  <footer><div class="small">Helping paranormal investigators everywhere find the things that go bump in the night since © 1989.</div></footer>

  <!-- Slime overlay canvases -->
  <div id="gooWrap" aria-hidden="true">
    <canvas id="goo"></canvas>
    <canvas id="gooHud"></canvas>
    <button id="gooClose" aria-label="Dismiss slime">×</button>
  </div>

  <!-- Search logic -->
  <script>
    let data=[], index, byUrl=new Map();

    function escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

    function highlight(text,query){
      if(!text||!query) return text||"";
      const terms=[...new Set(query.trim().split(/\s+/).filter(Boolean))];
      if(!terms.length) return text;
      const re=new RegExp("(" + terms.map(escapeRegExp).join("|") + ")", "ig");
      return text.replace(re,"<mark>$1</mark>");
    }

    async function load(){
      try{
        const r=await fetch("index.json",{cache:"no-store"});
        data=await r.json();
      }catch(e){
        console.warn("index.json missing or invalid; search will be empty.", e);
        data=[];
      }
      byUrl.clear(); for(const d of data){ if(d&&d.url) byUrl.set(d.url,d); }
      index=new FlexSearch.Document({document:{id:"url",index:["title","snippet","author","tags"]},tokenize:"forward"});
      for(const d of data){ try{ index.add(d);}catch{} }
    }

    function fallbackSearch(q){
      const ql=q.toLowerCase();
      return data.filter(d=>
        (d.title||"").toLowerCase().includes(ql)||
        (d.snippet||"").toLowerCase().includes(ql)||
        (d.author||"").toLowerCase().includes(ql)||
        (d.collection||"").toLowerCase().includes(ql)
      ).map(d=>d.url);
    }

    async function run(qArg){
      const qEl=document.getElementById('q');
      const q=(qArg!==undefined?qArg:qEl.value).trim();
      const box=document.getElementById('results');
      if(!index) await load();
      if(!q){ box.innerHTML=""; return; }
      let res=index.search(q,{enrich:true});
      let ids=[...new Set(res.flatMap(r=>r.result))];
      if(ids.length===0){ ids=fallbackSearch(q); }
      const hits=ids.map(u=>byUrl.get(u)).filter(Boolean).slice(0,50);
      box.innerHTML=hits.length?"":"<div class='card'>No results. Try broader terms.</div>";
      for(const h of hits){
        const el=document.createElement('div'); el.className="card";
        const title=highlight(h.title||h.url,q); const snip=highlight(h.snippet||"",q);
        el.innerHTML=`<div class="src">${h.collection||h.source||""} ${h.type?`· ${h.type}`:""}</div>
          <a class="titlelink" href="${h.url}" target="_blank" rel="noopener">${title}</a>
          <div class="snippet">${snip}</div>
          <div class="src">${h.author?`author: ${h.author} · `:""}${h.year?`year: ${h.year}`:""}</div>`;
        box.appendChild(el);
      }
    }

    function debounce(fn,d=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),d); }; }
    const runDebounced=debounce(run,250);
    document.getElementById('go').onclick=()=>run();
    document.getElementById('q').addEventListener('keydown',e=>{ if(e.key==="Enter"){ e.preventDefault(); run(); }});
  </script>

  <!-- Slime effect (Three.js via explicit CDN URLs) -->
  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
    import { MarchingCubes } from 'https://unpkg.com/three@0.160.0/examples/jsm/objects/MarchingCubes.js';
    import { RoomEnvironment } from 'https://unpkg.com/three@0.160.0/examples/jsm/environments/RoomEnvironment.js';

    const IDLE_MS = 45000;                   // 45s idle
    const wrap = document.getElementById('gooWrap');
    const hud = document.getElementById('gooHud');
    const closeBtn = document.getElementById('gooClose');

    // Single declarations (avoid redeclare errors)
    let hudCtx, W=0, H=0, dpr=1;
    let renderer, scene, camera, cubes, material, envTex;
    let running = false, raf, idleTimer, tLast = 0, tSpawn = 0;
    let balls = [];

    const SIM = {
      resolution: 70, maxBalls: 32, gravity: 18, viscosity: 0.985,
      spawnEvery: 0.22, spawnJitterX: 0.28, radiusBase: 0.7, radiusVar: 0.6, surface: 2.5
    };

    function fit(){
      dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
      W = wrap.clientWidth = window.innerWidth;
      H = wrap.clientHeight = window.innerHeight;

      renderer.setPixelRatio(dpr);
      renderer.setSize(W, H, false);

      hud.width = Math.round(W*dpr); hud.height = Math.round(H*dpr);
      hud.style.width = W+'px'; hud.style.height = H+'px';
      hudCtx.setTransform(dpr,0,0,dpr,0,0);

      camera.left = -W/2; camera.right = W/2;
      camera.top = H/2; camera.bottom = -H/2;
      camera.updateProjectionMatrix();

      cubes.position.set(-W/2, -H/2, 0);
      cubes.scale.set(W, H, Math.max(W,H));
    }

    async function init(){
      try{
        renderer = new THREE.WebGLRenderer({
          canvas: document.getElementById('goo'),
          antialias: true, alpha: true, powerPreference: 'high-performance'
        });
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.0;
      }catch(e){
        console.error('WebGL init failed:', e);
        return;
      }

      scene = new THREE.Scene();
      camera = new THREE.OrthographicCamera(-1,1,1,-1, -1000, 1000);
      camera.position.set(0,0,10);

      const pmrem = new THREE.PMREMGenerator(renderer);
      envTex = pmrem.fromScene(new RoomEnvironment(renderer), 0.5).texture;
      scene.environment = envTex;

      material = new THREE.MeshPhysicalMaterial({
        metalness: 0.0, roughness: 0.1,
        transmission: 1.0, thickness: 2.6, ior: 1.38,
        attenuationColor: new THREE.Color(1.0, 0.48, 0.62),
        attenuationDistance: 0.9,
        clearcoat: 0.5, clearcoatRoughness: 0.18,
        envMapIntensity: 1.3
      });

      cubes = new MarchingCubes(SIM.resolution, material, true, true, SIM.surface);
      scene.add(cubes);

      hudCtx = hud.getContext('2d');

      fit();
      window.addEventListener('resize', ()=>{ if(running) fit(); });
    }

    function spawn(dt){
      tSpawn += dt;
      if (tSpawn < SIM.spawnEvery || balls.length >= SIM.maxBalls) return;
      tSpawn = 0;
      const rx = (Math.random()*2-1) * SIM.spawnJitterX * W/2;
      balls.push({ x: W/2 + rx, y: -40, z: (Math.random()*2-1)*0.25, r: SIM.radiusBase + Math.random()*SIM.radiusVar, vy: 0 });
    }

    function step(dt){
      for (const b of balls){
        b.vy += SIM.gravity*dt;
        b.vy *= SIM.viscosity;
        b.y += b.vy;
      }
      balls = balls.filter(b => b.y < H + 100);

      cubes.reset();
      for (const b of balls){
        cubes.addBall(b.x/W, b.y/H, 0.5 + b.z*0.1, b.r, 1);
      }
      for (let i=0;i<12;i++){ cubes.addBall(i/11, -0.03, 0.5, 0.42, 0.8); } // lip
    }

    function drawHud(){
      const ctx = hudCtx;
      ctx.clearRect(0,0,W,H);

      // soft highlights
      ctx.globalCompositeOperation='lighter';
      ctx.globalAlpha = 0.24;
      const g1 = ctx.createRadialGradient(W*0.22, 90, 10, W*0.22, 90, 180);
      g1.addColorStop(0,'rgba(255,240,245,0.9)');
      g1.addColorStop(1,'rgba(255,240,245,0)');
      ctx.fillStyle=g1; ctx.beginPath(); ctx.arc(W*0.22,90,160,0,Math.PI*2); ctx.fill();

      const g2 = ctx.createRadialGradient(W*0.78, 110, 10, W*0.78, 110, 220);
      g2.addColorStop(0,'rgba(255,232,240,0.9)');
      g2.addColorStop(1,'rgba(255,232,240,0)');
      ctx.fillStyle=g2; ctx.beginPath(); ctx.arc(W*0.78,110,190,0,Math.PI*2); ctx.fill();

      ctx.globalAlpha=1; ctx.globalCompositeOperation='source-over';

      // shadow band
      const y = Math.min(H, balls.reduce((m,b)=>Math.max(m,b.y), 0)+30);
      const gl = ctx.createLinearGradient(0,y,0,y+80);
      gl.addColorStop(0,'rgba(0,0,0,0)');
      gl.addColorStop(1,'rgba(0,0,0,.35)');
      ctx.fillStyle=gl; ctx.fillRect(0,y,W,80);
    }

    function loop(ts){
      if(!running) return;
      if(!tLast) tLast = ts;
      const dt = Math.min(0.033, (ts - tLast)/1000);
      tLast = ts;

      spawn(dt);
      step(dt);

      renderer.render(scene, camera);
      drawHud();

      raf = requestAnimationFrame(loop);
    }

    function show(){
      if(running) return;
      if(!renderer){ init().then(show); return; }
      wrap.style.display='block';
      closeBtn.style.display='block';
      running = true; tLast = 0; balls.length = 0;
      raf = requestAnimationFrame(loop);
      wrap.setAttribute('aria-hidden','false');
    }
    function hide(){
      running = false; cancelAnimationFrame(raf);
      closeBtn.style.display='none'; wrap.style.display='none';
      wrap.setAttribute('aria-hidden','true');
    }
    function arm(){
      clearTimeout(idleTimer);
      if(running) hide();
      idleTimer = setTimeout(show, IDLE_MS);
    }

    closeBtn.addEventListener('click', (e)=>{ e.stopPropagation(); hide(); arm(); });
    wrap.addEventListener('click', ()=>{ hide(); arm(); });
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ hide(); arm(); } if(e.key.toLowerCase()==='s'){ show(); }});
    ['mousemove','keydown','scroll','touchstart','click'].forEach(ev=>window.addEventListener(ev, arm, {passive:true}));

    // Debug: ?slime=1 → show immediately
    if(new URLSearchParams(location.search).get('slime')==='1'){ setTimeout(show, 300); }
    window.addEventListener('DOMContentLoaded', arm);
  </script>

  <!-- Retro pixel arrow cursor (no external files) -->
  <script>
    (function(){
      const c = document.createElement('div');
      c.className = 'crt-cursor';
      document.body.appendChild(c);

      let x=window.innerWidth/2, y=window.innerHeight/2, tx=x, ty=y;
      const speed = 0.35; // smoothing

      function move(e){ tx = e.clientX; ty = e.clientY; }
      function loop(){
        x += (tx - x) * speed;
        y += (ty - y) * speed;
        c.style.transform = `translate(${x}px,${y}px)`;
        requestAnimationFrame(loop);
      }
      window.addEventListener('mousemove', move, {passive:true});
      window.addEventListener('mousedown', ()=>{ c.classList.add('click'); });
      window.addEventListener('mouseup',   ()=>{ c.classList.remove('click'); });
      loop();
    })();
  </script>

</body>
</html>
